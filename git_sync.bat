@echo off
title Git 终极重置上传工具 (修复文件损坏)

:: --- 进入脚本所在目录 ---
cd /d "%~dp0"

echo ========================================
echo   Git 终极重置上传工具
echo ========================================
echo.
echo   [功能] 1. 修复文件上传后变大/损坏的问题
echo          2. 强制重新上传所有文件
echo          3. 使得服务器内容与本地完全一致
echo.
echo   [警告] 这将花费较长时间，因为需要重新上传所有大文件！
echo.
echo ----------------------------------------
echo   [确认] 请按 [回车键] 开始彻底重置...
echo ----------------------------------------
pause >nul

:: --- 步骤 1：建立防损坏保护 (最关键一步) ---
echo.
echo [1/5] 配置二进制文件保护 (.gitattributes)...
:: 这两行命令是防止文件变大的护身符
echo *.bin* binary > .gitattributes
echo ai/*.bin* binary >> .gitattributes

:: --- 步骤 2：清除 Git 缓存 ---
echo.
echo [2/5] 清空 Git 缓存记录...
echo       (不用担心，这不会删除你的本地文件，只会删除 Git 的记忆)
:: 这一步会让 Git 以为所有文件都是新来的
git rm -r --cached . >nul 2>&1

:: --- 步骤 3：重新添加文件 ---
echo.
echo [3/5] 重新扫描并添加文件...
echo       (正在重新计算文件指纹，请稍候...)
:: 此时 Git 会根据第1步的配置，正确地把 .bin 识别为二进制
git add .

:: --- 步骤 4：生成全新提交 ---
echo.
echo [4/5] 生成全新的提交记录...
set msg=Fix_Binary_Corruption_Reset_%date:~0,10%
set msg=%msg:/=-%
git commit -m "%msg%"

:: --- 步骤 5：强制推送到服务器 ---
echo.
echo [5/5] 正在重新上传所有文件 (git push --force)...
echo       ==============================================
echo       注意：这将重新上传所有几百 MB 的数据！
echo       请耐心等待，不要关闭窗口。
echo       ==============================================
echo.

git push origin main --force

if %ERRORLEVEL% EQU 0 (
    echo.
    echo ========================================
    echo [成功] 修复完成！
    echo ========================================
    echo 现在去 GitHub 下载文件，大小应该和本地完全一致了。
) else (
    echo.
    echo ========================================
    echo [失败] 上传中断，请检查网络后重试。
    echo ========================================
)

echo.
echo 任务结束，按任意键退出...
pause >nul